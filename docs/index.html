<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>El Viaje Digital del Cliente - Lobby</title>
  <style>
    body{margin:0;font-family:Segoe UI,system-ui;background:linear-gradient(#b3d9ff,#e6f2ff);text-align:center}
    h1{margin:22px 0 6px}
    .card{background:#fff;width:92%;max-width:980px;margin:14px auto;padding:16px;border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.15);text-align:left}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-weight:800;display:block;margin:10px 0 6px}
    input,select,button{width:100%;padding:11px;border-radius:12px;border:1px solid #cfd8e3;font-size:1em}
    button{background:#004aad;color:#fff;font-weight:900;border:none;cursor:pointer}
    button:hover{background:#00317a}
    .pill{display:inline-block;padding:7px 12px;border-radius:999px;font-weight:900;font-size:.92em;background:#dcecff;color:#00317a;margin-right:8px}
    .box{background:#f6f9ff;border:1px solid #e3ecff;border-radius:14px;padding:12px}
    .muted{color:#456;opacity:.9}
    ul{margin:8px 0 0 18px}
  </style>
</head>
<body>
  <h1>ğŸ“ El Viaje Digital del Cliente</h1>
  <div class="muted">Lobby en vivo (entra aquÃ­ primero)</div>

  <div class="card">
    <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;align-items:center">
      <div>
        <span class="pill" id="phase">Fase: lobby</span>
        <span class="pill" id="count">0 conectados</span>
      </div>
      <div class="muted">Host: <a href="./host.html" target="_blank">abrir panel</a></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div>
        <label>ğŸ‘¤ Tu nombre</label>
        <input id="nombre" placeholder="Ej. Andrea, Vivi, Carlos"/>

        <label>ğŸšŒ Â¿CÃ³mo llegas a la U?</label>
        <select id="transporte">
          <option>ğŸšŒ Bus (gallinera)</option>
          <option>ğŸš— Carro</option>
          <option>ğŸï¸ Moto</option>
          <option>ğŸš¶ A pie</option>
        </select>

        <label>ğŸ§‘â€ğŸ“ Personaje</label>
        <select id="personaje">
          <option>Mujer (Falda + blusa)</option>
          <option>Mujer (jean + blusa)</option>
          <option>Hombre (jean + camiseta)</option>
          <option>Hombre (short + camisa)</option>
        </select>

        <label>ğŸ¨ Piel</label>
        <select id="piel">
          <option>Blanca</option>
          <option>Morena</option>
        </select>

        <label>ğŸ’‡ Pelo</label>
        <select id="pelo">
          <option>Negro</option>
          <option>CastaÃ±o</option>
          <option>Rubio</option>
          <option>PelÃ³n</option>
        </select>

        <label>ğŸ‘• Color camisa/blusa</label>
        <select id="ropa">
          <option>Azul</option>
          <option>Verde</option>
          <option>Rosa</option>
          <option>Gris</option>
        </select>

        <button id="btn">Entrar a la Universidad</button>
        <div class="muted" style="margin-top:10px">
          Cuando den â€œIniciar juegoâ€, te manda automÃ¡tico al juego ğŸ®
        </div>
      </div>

      <div>
        <div class="box">
          <b>ğŸ« SalÃ³n en vivo</b>
          <div id="lista" class="muted" style="margin-top:8px">Cargandoâ€¦</div>
        </div>

        <div class="box" style="margin-top:12px">
          <b>ğŸ“£ Eventos</b>
          <div id="events" class="muted" style="margin-top:8px">â€”</div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import {
    hostInit, hostListen, lobbyListen, joinLobby, pingLobby, eventsListen
  } from "./firebase.js";

  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

  await hostInit();

  let myId = sessionStorage.getItem("vd_id") || "";
  let joined = sessionStorage.getItem("vd_joined")==="1";

  hostListen((h)=>{
    const phase = (h?.phase || "lobby");
    $("phase").textContent = "Fase: " + phase;

    if ((phase === "juego") && joined) {
      location.href = "./juego.html";
    }
  });

  lobbyListen((obj)=>{
    const ids = obj ? Object.keys(obj) : [];
    $("count").textContent = `${ids.length} conectados`;
    if(!obj){ $("lista").innerHTML = "â€”"; return; }

    const arr = Object.values(obj).filter(Boolean).slice(-40).reverse();
    $("lista").innerHTML = "<ul>" + arr.map(x=>{
      const tag = x.status === "offline" ? " (offline)" : "";
      return `<li>${esc(x.nombre)}${tag}</li>`;
    }).join("") + "</ul>";
  });

  eventsListen((obj)=>{
    if(!obj){ $("events").textContent="â€”"; return; }
    const arr = Object.values(obj).filter(Boolean).slice(-8).reverse();
    $("events").innerHTML = "<ul>" + arr.map(e=>`<li>${esc(e.texto)}</li>`).join("") + "</ul>";
  });

  $("btn").addEventListener("click", async ()=>{
    const nombre = $("nombre").value.trim();
    if(!nombre) return alert("Escribe tu nombre ğŸ˜Š");

    const payload = {
      id: myId || undefined,
      nombre,
      transporte: $("transporte").value,
      personaje: $("personaje").value,
      piel: $("piel").value,
      pelo: $("pelo").value,
      ropa: $("ropa").value
    };

    try{
      myId = await joinLobby(payload);
      sessionStorage.setItem("vd_id", myId);
      sessionStorage.setItem("vd_joined","1");
      sessionStorage.setItem("vd_nombre", nombre);
      joined = true;
      alert("Â¡Listo! Ya estÃ¡s en el salÃ³n. Espera a que la Licda inicie el juego ğŸ®");
    }catch(e){
      console.error(e);
      alert("No se pudo entrar. Revisa Rules en Firebase (read/write).");
    }
  });

  setInterval(()=>{ if(myId && joined) pingLobby(myId); }, 15000);
</script>
</body>
</html>
