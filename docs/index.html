<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>El Viaje Digital del Cliente</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:0;background:linear-gradient(180deg,#bfe0ff,#f4f7ff);}
    .wrap{max-width:980px;margin:24px auto;padding:16px;}
    .card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.12);padding:18px;}
    h1{margin:0 0 6px;font-size:34px}
    .sub{opacity:.7;margin:0 0 18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #d0d7e2;font-size:16px}
    .btn{margin-top:14px;width:100%;padding:14px;border:0;border-radius:12px;background:#0b56c1;color:#fff;font-size:18px;font-weight:800;cursor:pointer}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;color:#0a2b4a;margin-right:8px}
    .pill.blue{background:#5bd0ff}
    .pill.green{background:#41d37a}
    .box{background:#f6f8fc;border:1px solid #e3e9f5;border-radius:14px;padding:12px}
    .list{margin:8px 0 0;padding-left:18px}
    .muted{opacity:.75}
    .hearts{color:#ff2a67;font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ“ El Viaje Digital del Cliente</h1>
      <p class="sub">Batalla universitaria â€” todos juegan en vivo</p>

      <div class="grid">
        <!-- IZQ: FORM -->
        <div>
          <label>ğŸ‘¤ Tu nombre</label>
          <input id="name" placeholder="Ej: Vivi, Ana, Carlos" />

          <label>ğŸ§‘â€ğŸ“ Personaje</label>
          <select id="personaje">
            <option>Mujer (lona + blusa 3/4)</option>
            <option>Hombre (jean + camiseta)</option>
            <option>Hombre (short + camisa)</option>
          </select>

          <label>ğŸšŒ Â¿CÃ³mo llegas a la U?</label>
          <select id="transporte">
            <option>Bus (gallinera)</option>
            <option>A pie</option>
            <option>Carro</option>
            <option>Moto</option>
          </select>

          <label>ğŸ¨ Piel</label>
          <select id="piel">
            <option>Blanca</option>
            <option>Morena clara</option>
          </select>

          <label>ğŸ’‡ Pelo</label>
          <select id="pelo">
            <option>Negro</option>
            <option>CastaÃ±o</option>
            <option>Rubio</option>
          </select>

          <label>ğŸ‘š Color camisa/blusa</label>
          <select id="blusa">
            <option>Azul</option>
            <option>Rosa</option>
            <option>Negra</option>
            <option>Blanca</option>
          </select>

          <button class="btn" id="btnJoin">Entrar a la Universidad</button>

          <div class="box" style="margin-top:12px">
            â³ <b>Esperando que la Licda inicie el juego...</b><br>
            <span class="muted">Host (tÃº): abre <b>host.html</b> para iniciar / controlar.</span>
          </div>
        </div>

        <!-- DER: LOBBY -->
        <div>
          <div style="margin-bottom:10px">
            <span class="pill blue" id="phasePill">Fase: Lobby</span>
            <span class="pill green" id="countPill">0 conectados</span>
          </div>

          <div class="box">
            ğŸ« <b>SalÃ³n en vivo</b>
            <div id="lobbyState" class="muted" style="margin-top:6px">Cargando...</div>
            <ul id="lobbyList" class="list"></ul>
          </div>

          <div class="box" style="margin-top:12px">
            ğŸ“£ <b>Eventos (se ven para todos)</b>
            <div id="eventsTxt" class="muted" style="margin-top:6px">AÃºn no hay eventos...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { joinLobby, listenLobby, listenPhase, listenEvents } from "./firebase.js";

    const $ = (id) => document.getElementById(id);

    // UI listeners
    listenLobby((players) => {
      $("countPill").textContent = `${players.length} conectados`;
      $("lobbyState").textContent = players.length ? "" : "AÃºn no se conecta nadie...";
      $("lobbyList").innerHTML = players.map(p =>
        `<li><b>${escapeHtml(p.name||"")}</b> <span class="hearts">â™¥ â™¥ â™¥ â™¥ â™¥</span></li>`
      ).join("");
    });

    listenPhase((phase) => {
      $("phasePill").textContent = `Fase: ${phase === "game" ? "Juego" : "Lobby"}`;
      // âœ… si la fase pasa a game => manda a juego.html
      if (phase === "game") window.location.href = "./juego.html";
    });

    listenEvents((txt) => $("eventsTxt").textContent = txt);

    // Join button
    $("btnJoin").addEventListener("click", async () => {
      const name = $("name").value.trim();
      if (!name) return alert("Escribe tu nombre ğŸ˜Š");

      $("btnJoin").disabled = true;
      $("btnJoin").textContent = "Entrando...";

      try {
        await joinLobby({
          name,
          personaje: $("personaje").value,
          transporte: $("transporte").value,
          piel: $("piel").value,
          pelo: $("pelo").value,
          blusa: $("blusa").value
        });
        $("btnJoin").textContent = "Â¡Listo! Espera a la Licda...";
      } catch (e) {
        console.error(e);
        alert("No se pudo entrar. Revisa Rules de Firebase (read/write true).");
        $("btnJoin").disabled = false;
        $("btnJoin").textContent = "Entrar a la Universidad";
      }
    });

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }
  </script>
</body>
</html>
