<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>El Viaje Digital del Cliente ‚Äî Entrada</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#b3d9ff,#e6f2ff);min-height:100vh}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 16px 40px rgba(0,0,0,.12)}
  h1{margin:0 0 6px}
  .muted{opacity:.75}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:780px){.row{grid-template-columns:1fr}}
  label{display:block;font-weight:800;margin:10px 0 6px}
  input,select{width:100%;padding:11px;border-radius:12px;border:1px solid #d7d7d7;font-size:16px}
  button{width:100%;padding:12px;border-radius:12px;border:0;background:#004aad;color:#fff;font-weight:900;cursor:pointer}
  button:hover{background:#00327a}
  .arena{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .chip{width:160px;border-radius:16px;border:1px solid #e5e5e5;background:#fafafa;padding:10px}
  .mini{height:46px;border-radius:12px;position:relative;background:#fff;border:1px solid #eee;overflow:hidden}
  .hair{position:absolute;left:50px;top:7px;width:34px;height:12px;border-radius:12px}
  .head{position:absolute;left:52px;top:11px;width:26px;height:26px;border-radius:999px}
  .shirt{position:absolute;left:44px;top:27px;width:42px;height:16px;border-radius:10px}
  .nm{font-weight:900;margin-top:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{font-size:12px;opacity:.85}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef4ff;color:#0b3ea3;font-weight:900;margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üéì El Viaje Digital del Cliente</h1>
    <div class="muted">Entrada al juego (multijugador en vivo). Todos se ver√°n en el sal√≥n.</div>

    <div class="pill">C√≥digo de clase: <span id="roomTxt">CLASE1</span></div>

    <div class="row">
      <div>
        <label>Tu nombre</label>
        <input id="name" placeholder="Ej: Ana, Carlos, Vivi">
      </div>
      <div>
        <label>G√©nero</label>
        <select id="gender">
          <option value="mujer">Mujer (lona + blusa 3/4)</option>
          <option value="hombre">Hombre (jean + camisa)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Piel</label>
        <select id="skin">
          <option value="#f3d7c5">Blanca</option>
          <option value="#d2b49a">Morena clara</option>
        </select>
      </div>
      <div>
        <label>Pelo</label>
        <select id="hair">
          <option value="#1f1f1f">Negro</option>
          <option value="#6a3f2b">Casta√±o</option>
          <option value="#d7b55a">Rubio</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Camisa / Blusa</label>
        <select id="shirt">
          <option value="#2f6fff">Azul</option>
          <option value="#ff5c7c">Rosa</option>
          <option value="#111111">Negra</option>
          <option value="#ffffff">Blanca</option>
        </select>
      </div>
      <div>
        <label>¬øC√≥mo llegas a la U?</label>
        <select id="transport">
          <option value="bus">üöå Bus (gallinera)</option>
          <option value="carro">üöó Carro</option>
          <option value="moto">üèçÔ∏è Moto</option>
          <option value="pie">üö∂ A pie</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>C√≥digo de clase (opcional)</label>
        <input id="room" value="CLASE1">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="join">Entrar al sal√≥n</button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px">Sal√≥n en vivo (qui√©nes ya est√°n conectados):</div>
    <div class="arena" id="arena"></div>

    <div class="muted" style="margin-top:10px">
      Cuando entras, te manda autom√°ticamente al juego.  
      Si se queda ‚Äúcargando‚Äù, abre en modo inc√≥gnito.
    </div>
  </div>
</div>

<script type="module">
import { db, dbRef, dbSet, dbUpdate, dbOnValue, dbTs, qs, uid } from "./firebase.js";

const roomInput = document.getElementById("room");
const roomTxt = document.getElementById("roomTxt");
const arena = document.getElementById("arena");

function esc(s){return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]))}

function renderPlayers(players){
  const arr = Object.values(players || {});
  arena.innerHTML = arr.map(p=>`
    <div class="chip">
      <div class="mini">
        <div class="hair" style="background:${p.hair}"></div>
        <div class="head" style="background:${p.skin}"></div>
        <div class="shirt" style="background:${p.shirt};${p.shirt==="#ffffff"?"border:1px solid rgba(0,0,0,.12)":""}"></div>
      </div>
      <div class="nm">${p.gender==="mujer"?"üë©‚Äçüéì":"üë®‚Äçüéì"} ${esc(p.name)}</div>
      <div class="meta">${esc(p.transportLabel)} ¬∑ ‚ô•‚ô•‚ô•‚ô•‚ô•</div>
    </div>
  `).join("");
}

function transportLabel(v){
  return v==="bus" ? "üöå Bus (gallinera)" :
         v==="carro" ? "üöó Carro" :
         v==="moto" ? "üèçÔ∏è Moto" : "üö∂ A pie";
}

function watchLobby(room){
  roomTxt.textContent = room;
  const lobbyRef = dbRef(db, `rooms/${room}/players`);
  dbOnValue(lobbyRef, snap => renderPlayers(snap.val()));
}

const urlRoom = qs("room");
if(urlRoom){ roomInput.value = urlRoom; }
watchLobby(roomInput.value.trim() || "CLASE1");

roomInput.addEventListener("input", ()=> watchLobby(roomInput.value.trim()||"CLASE1"));

document.getElementById("join").onclick = async ()=>{
  const room = roomInput.value.trim() || "CLASE1";
  const name = document.getElementById("name").value.trim();
  if(!name) return alert("Escribe tu nombre üòä");

  const playerId = uid();
  const gender = document.getElementById("gender").value;
  const skin = document.getElementById("skin").value;
  const hair = document.getElementById("hair").value;
  const shirt = document.getElementById("shirt").value;
  const transport = document.getElementById("transport").value;

  // crear room si no existe (estado inicial)
  await dbUpdate(dbRef(db, `rooms/${room}`), {
    state: "lobby",
    level: 1,
    timeOfDay: "ma√±ana",
    qIndex: 0,
    paused: false,
    pauseText: "",
    updatedAt: dbTs()
  });

  // registrar jugador
  await dbSet(dbRef(db, `rooms/${room}/players/${playerId}`), {
    id: playerId,
    name,
    gender,
    skin,
    hair,
    shirt,
    transport,
    transportLabel: transportLabel(transport),
    lives: 5,
    score: 0,
    out: false,
    answered: false,
    lastAnswer: null,
    joinedAt: Date.now()
  });

  // guardar en navegador
  localStorage.setItem("vdc_room", room);
  localStorage.setItem("vdc_playerId", playerId);

  // ir al juego
  location.href = `juego.html?room=${encodeURIComponent(room)}`;
};
</script>
</body>
</html>
