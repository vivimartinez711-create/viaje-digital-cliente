<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>El Viaje Digital del Cliente â€” Lobby</title>
  <style>
    body{margin:0;font-family:Segoe UI,system-ui;background:linear-gradient(#b3d9ff,#e6f2ff);color:#0b1220}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    h1{margin:14px 0 6px;text-align:center}
    .sub{text-align:center;margin:0 0 14px;opacity:.85}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:22px;box-shadow:0 14px 35px rgba(0,0,0,.14);padding:16px}
    label{display:block;font-weight:800;margin:10px 0 6px}
    input,select,button{width:100%;padding:11px 12px;border-radius:14px;border:1px solid #cfd3df;font-size:16px;box-sizing:border-box}
    button{background:#004aad;color:#fff;font-weight:900;border:none;cursor:pointer}
    button:hover{background:#00317a}
    .pill{display:inline-block;background:#0ea5e9;color:#001019;font-weight:900;padding:6px 10px;border-radius:999px;margin-right:8px}
    .pill2{background:#22c55e;color:#02110a}
    .list{background:#f6f7fb;border:1px solid #e8eaf3;border-radius:18px;padding:12px;min-height:140px;white-space:pre-line;line-height:1.65}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{font-size:13px;opacity:.8;margin-top:10px}
    .avatar{display:flex;justify-content:center;align-items:center;background:#f6f7fb;border:1px solid #e8eaf3;border-radius:18px;padding:10px;margin-top:10px}
    .avatar svg{width:170px;height:170px}
    .status{margin-top:10px;padding:10px;border-radius:14px;background:#0b1220;color:#fff;font-weight:900}
    .small{font-size:13px;opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“ El Viaje Digital del Cliente</h1>
    <p class="sub">Lobby â€” entren todos, y cuando la Licda inicie, pasan solos al juego ğŸ®</p>

    <div class="grid">
      <div class="card">
        <label>ğŸ‘¤ Tu nombre</label>
        <input id="nombre" placeholder="Ej. Vivi, Ana, Carlos" />

        <label>ğŸ§‘â€ğŸ“ Personaje</label>
        <select id="sexo">
          <option value="mujer">Mujer (lona + blusa 3/4)</option>
          <option value="hombre">Hombre (jeans + camisa)</option>
        </select>

        <label>ğŸš Â¿CÃ³mo llegas a la U?</label>
        <select id="transporte">
          <option value="bus">ğŸšŒ Bus (gallinera)</option>
          <option value="carro">ğŸš— Carro</option>
          <option value="moto">ğŸï¸ Moto</option>
          <option value="pie">ğŸš¶ A pie</option>
        </select>

        <label>ğŸ¨ Piel</label>
        <select id="piel">
          <option value="blanca">Blanca</option>
          <option value="morena_clara">Morena clara</option>
        </select>

        <label>ğŸ’‡ Pelo</label>
        <select id="pelo">
          <option value="negro">Negro</option>
          <option value="castano">CastaÃ±o</option>
          <option value="rubio">Rubio</option>
        </select>

        <label>ğŸ‘• Color camisa/blusa</label>
        <select id="ropa">
          <option value="azul">Azul</option>
          <option value="verde">Verde</option>
          <option value="rosa">Rosa</option>
          <option value="gris">Gris</option>
        </select>

        <div class="avatar" id="avatarBox"></div>

        <button id="btnEntrar">Entrar a la Universidad</button>
        <div class="status" id="estado">â³ Esperandoâ€¦</div>
        <div class="hint">Host (tÃº): abre <b>anfitrion.html</b> y presiona â€œIniciar Juegoâ€.</div>
      </div>

      <div class="card">
        <div class="row">
          <span class="pill" id="fasePill">Fase: Lobby</span>
          <span class="pill pill2" id="countPill">0 conectados</span>
        </div>

        <h3 style="margin:12px 0 8px">ğŸ« SalÃ³n en vivo</h3>
        <div class="list" id="lista">Cargandoâ€¦</div>

        <p class="small" style="margin-top:10px">
          âœ… Si alguien pierde todas sus vidas, se verÃ¡ una pausa en pantalla para todos.
        </p>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="./firebase.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const avatarBox = $("avatarBox");

    function avatarSVG({sexo, piel, pelo, ropa}) {
      const skin = (piel==="blanca") ? "#f7d7c4" : "#d9b08c";
      const hair =
        (pelo==="negro") ? "#1b1b1b" :
        (pelo==="castano") ? "#5a3b2e" : "#d7b26a";
      const top =
        (ropa==="azul") ? "#2b6cff" :
        (ropa==="verde") ? "#20b26b" :
        (ropa==="rosa") ? "#ff4fa3" : "#6c7a89";

      const jeans = "#1f3a8a";      // hombre
      const lona  = "#334155";      // mujer
      const shoes = "#111827";
      const isF = (sexo==="mujer");

      return `
      <svg viewBox="0 0 220 220" xmlns="http://www.w3.org/2000/svg">
        <circle cx="110" cy="110" r="92" fill="#f2f6ff"/>
        <g>
          <circle cx="110" cy="78" r="40" fill="${skin}"/>
          <path d="M70 72c6-32 32-50 40-50s34 18 40 50c-10-10-22-16-40-16S80 62 70 72z" fill="${hair}"/>
          <circle cx="95" cy="82" r="5.5" fill="#111827"/>
          <circle cx="125" cy="82" r="5.5" fill="#111827"/>
          <path d="M97 104c9 10 25 10 34 0" stroke="#111827" stroke-width="5" fill="none" stroke-linecap="round"/>
          <path d="M72 140c8-26 24-40 38-40s30 14 38 40" fill="${top}"/>
          ${isF
            ? `<path d="M80 140h60v44H80z" fill="${lona}"/>`
            : `<path d="M80 140h60v44H80z" fill="${jeans}"/>`
          }
          <rect x="78" y="204" width="30" height="8" rx="4" fill="${shoes}"/>
          <rect x="112" y="204" width="30" height="8" rx="4" fill="${shoes}"/>
        </g>
      </svg>`;
    }

    function renderPreview(){
      avatarBox.innerHTML = avatarSVG({
        sexo: $("sexo").value,
        piel: $("piel").value,
        pelo: $("pelo").value,
        ropa: $("ropa").value
      });
    }
    ["sexo","piel","pelo","ropa"].forEach(id => $(id).addEventListener("change", renderPreview));
    renderPreview();

    // Estado de juego
    DB.ref("game/state").on("value", (snap)=>{
      const g = snap.val() || {};
      $("fasePill").textContent = "Fase: " + (g.status || "Lobby");
      if (g.status === "playing") {
        // si ya se registrÃ³, entra solo
        const myId = localStorage.getItem("vdcc_playerId");
        if (myId) location.href = "./juego.html";
      }
    });

    // SalÃ³n en vivo
    DB.ref("players").on("value", (snap)=>{
      const obj = snap.val() || {};
      const arr = Object.entries(obj).map(([id,p])=>({id,...p}))
        .sort((a,b)=>(a.nombre||"").localeCompare(b.nombre||""));
      $("countPill").textContent = `${arr.length} conectados`;
      if (!arr.length) { $("lista").textContent = "AÃºn no hay estudiantes conectadosâ€¦"; return; }

      const lines = arr.map(p=>{
        const hearts = heartsText(p.heartsHalf ?? 10);
        const st = p.eliminado ? " â€” âŒ Fuera" : "";
        return `â€¢ ${p.nombre} ${hearts} (Puntaje: ${p.score||0})${st}`;
      });
      $("lista").textContent = lines.join("\n");
    });

    function heartsText(half){
      const full = Math.floor(half/2);
      const halfHeart = (half%2) ? "ğŸ’—" : "";
      return "â¤ï¸".repeat(full) + halfHeart;
    }

    // Entrar
    $("btnEntrar").addEventListener("click", async ()=>{
      const nombre = $("nombre").value.trim();
      if (!nombre) return alert("Escribe tu nombre ğŸ˜Š");

      const id = (crypto?.randomUUID?.() || ("id_"+Date.now()+"_"+Math.random().toString(16).slice(2)));
      localStorage.setItem("vdcc_playerId", id);

      const p = {
        nombre,
        sexo: $("sexo").value,
        transporte: $("transporte").value,
        piel: $("piel").value,
        pelo: $("pelo").value,
        ropa: $("ropa").value,
        heartsHalf: 10,   // 5 corazones = 10 medios
        eliminado: false,
        score: 0,
        joinedAt: Date.now()
      };

      await DB.ref("players/"+id).set(p);
      $("estado").textContent = "âœ… Registrado/a. Espera que la Licda inicieâ€¦";
      alert("âœ… Listo. Ya estÃ¡s en el salÃ³n. Cuando inicie, entras solo/a.");
    });
  </script>
</body>
</html>

