<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Viaje Digital del Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(#b3d9ff, #e6f2ff);
      text-align: center;
      min-height: 100vh;
    }
    h1 { margin-top: 26px; }
    .card {
      background: white;
      width: 92%;
      max-width: 440px;
      margin: 18px auto 30px;
      padding: 22px;
      border-radius: 22px;
      box-shadow: 0 10px 25px rgba(0,0,0,.15);
    }
    select, input, button {
      width: 100%;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      font-size: 1em;
      box-sizing: border-box;
    }
    button {
      background: #004aad;
      color: white;
      font-weight: 800;
      cursor: pointer;
      border: none;
      padding: 12px 14px;
      border-radius: 14px;
      margin-top: 14px;
      box-shadow: 0 8px 18px rgba(0,74,173,.25);
    }
    button:hover { filter: brightness(.95); }
    .emoji { font-size: 2em; margin: 10px 0 6px; }
    .muted { color:#3b3b3b; font-size: .92em; margin-top: 8px; }
    .hr { height:1px; background:#eee; margin:16px 0; }
    #lista {
      text-align:left;
      font-size:0.95em;
      line-height:1.55;
      background:#f7fbff;
      border:1px solid #e8f1ff;
      border-radius:14px;
      padding:10px 12px;
      min-height: 42px;
    }
    .pill {
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:#eef6ff;
      border:1px solid #d7ebff;
      font-size:.86em;
      margin-left:6px;
    }
  </style>
</head>

<body>
  <h1>ğŸ“ El Viaje Digital del Cliente</h1>
  <p>Experiencia universitaria interactiva</p>

  <div class="card">
    <h3>ğŸ‘¤ Tu nombre</h3>
    <input id="nombre" placeholder="Ej. Vivi, Ana, Carlos" />

    <div class="hr"></div>

    <h3>ğŸ« SalÃ³n (en vivo)</h3>
    <div id="lista">Cargando salÃ³n...</div>

    <div class="hr"></div>

    <h3>ğŸš Â¿CÃ³mo llegas a la U?</h3>
    <select id="transporte">
      <option value="bus">ğŸšŒ Bus (gallinera)</option>
      <option value="carro">ğŸš— Carro</option>
      <option value="moto">ğŸï¸ Moto</option>
      <option value="pie">ğŸš¶ A pie</option>
    </select>

    <h3 style="margin-top:18px;">ğŸ¨ Personaliza tu personaje</h3>
    <select id="piel">
      <option value="clara">Piel clara</option>
      <option value="media">Piel media</option>
      <option value="oscura">Piel oscura</option>
    </select>

    <select id="pelo">
      <option value="negro">Pelo negro</option>
      <option value="castaÃ±o">Pelo castaÃ±o</option>
      <option value="rubio">Pelo rubio</option>
    </select>

    <select id="ropa">
      <option value="azul">Camisa/Blusa azul</option>
      <option value="verde">Camisa/Blusa verde</option>
      <option value="rosa">Camisa/Blusa rosa</option>
      <option value="gris">Camisa/Blusa gris</option>
    </select>

    <div class="emoji">ğŸ’ğŸ§‘â€ğŸ“ğŸ‘©â€ğŸ“</div>

    <button id="btnEntrar">Entrar a la Universidad</button>
    <div class="muted">Cuando la Licda inicie el juego, aquÃ­ pasarÃ¡n a la siguiente fase ğŸ®</div>

    <div class="muted" style="margin-top:10px;">
      Panel Host (solo tÃº): <span class="pill">/host.html</span>
    </div>
  </div>

  <script type="module">
    import {
      ensureGameState,
      joinLobby,
      listenPlayers,
      listenState,
      getOrCreatePlayerId,
      heartbeat,
      playerSetStatus
    } from "./firebase.js";

    const lista = document.getElementById("lista");
    const btnEntrar = document.getElementById("btnEntrar");

    // 1) Asegura que exista estado base
    ensureGameState();

    // 2) Render del salÃ³n
    listenPlayers((players) => {
      if (!players.length) {
        lista.textContent = "AÃºn no hay estudiantes en el salÃ³n.";
        return;
      }
      lista.innerHTML = players.map(p => {
        const hearts = "â¤ï¸".repeat(Math.max(0, Math.min(3, Number(p.lives ?? 3))));
        const st = p.status === "salio" ? "â€” saliÃ³" :
                   p.status === "out" ? "â€” fuera" :
                   p.status === "finished" ? "â€” final" : "";
        return `â€¢ ${escapeHtml(p.nombre || "sin nombre")} ${hearts} ${st}`;
      }).join("<br>");
    });

    // 3) Si la fase cambia a play => manda a juego
    listenState((state) => {
      const phase = state.phase || "lobby";
      if (phase === "play") {
        window.location.href = "./juego.html";
      }
    });

    // 4) BotÃ³n entrar (guardar en Firebase)
    btnEntrar.addEventListener("click", async () => {
      const nombre = document.getElementById("nombre").value.trim();
      if (!nombre) return alert("Escribe tu nombre primero ğŸ˜Š");

      const transporte = document.getElementById("transporte").value;
      const piel = document.getElementById("piel").value;
      const pelo = document.getElementById("pelo").value;
      const ropa = document.getElementById("ropa").value;

      await joinLobby({ nombre, transporte, piel, pelo, ropa });
      alert("Â¡Listo! Ya estÃ¡s en el salÃ³n en vivo âœ…");
    });

    // 5) Heartbeat (mantener â€œen lÃ­neaâ€)
    const pid = getOrCreatePlayerId();
    setInterval(() => heartbeat(pid), 15000);

    // si abren index, marcamos lobby
    playerSetStatus(pid, "lobby").catch(()=>{});

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) =>
        ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m])
      );
    }
  </script>
</body>
</html>

