<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Host - Viaje Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{margin:0;font-family:"Segoe UI",sans-serif;background:radial-gradient(circle at 30% 10%,#223b6e,#0b1020);color:#eaf0ff}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 6px}
    .muted{opacity:.85}
    .card{margin-top:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:16px}
    input,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.20);font-size:1em}
    input{background:rgba(0,0,0,.25);color:#fff}
    button{background:#2f6df6;color:#fff;font-weight:900;border:none;cursor:pointer}
    button:hover{background:#2457c6}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    .pill{display:inline-block;padding:7px 12px;border-radius:999px;font-weight:900;font-size:.92em;background:rgba(255,255,255,.12)}
    .box{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px}
    ul{margin:8px 0 0 18px}
    .danger{background:#ff3b3b}
    .danger:hover{background:#d12f2f}
    .ghost{background:rgba(255,255,255,.12)}
    .ghost:hover{background:rgba(255,255,255,.18)}
    a{color:#a8c6ff}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ‘©â€ğŸ« Panel Host (Licda = tÃº)</h1>
    <div class="muted">Control en vivo â€” El Viaje Digital del Cliente</div>

    <div class="card" id="loginCard">
      <div class="row">
        <div>
          <div class="pill">ğŸ”’ Acceso</div>
          <div style="margin-top:10px" class="muted">PIN</div>
          <input id="pin" placeholder="PIN (2026)" />
        </div>
        <div style="display:flex;align-items:end">
          <button id="btnEntrar">Entrar</button>
        </div>
      </div>
      <div class="muted" style="margin-top:10px">Tip: si no te deja, prueba en incÃ³gnito.</div>
    </div>

    <div class="card" id="panelCard" style="display:none">
      <div class="row">
        <div class="box">
          <div class="pill" id="fasePill">Fase: Lobby</div>
          <div style="margin-top:10px" class="muted">Conectados:</div>
          <div style="font-size:28px;font-weight:900" id="count">0</div>
          <div class="muted">Lobby: <a href="./index.html" target="_blank">abrir</a></div>
        </div>

        <div class="box">
          <div class="pill">ğŸ® Controles</div>
          <div style="margin-top:10px" class="row">
            <button id="btnStart">â–¶ Iniciar Juego</button>
            <button id="btnLobby" class="ghost">â†© Volver a Lobby</button>
            <button id="btnReset" class="danger">ğŸ§¨ Reset total</button>
          </div>
          <div class="muted" style="margin-top:10px">
            â€œIniciar Juegoâ€ manda a todos a <b>juego.html</b> automÃ¡ticamente.
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="box">
          <div class="pill">ğŸ« Lista (salÃ³n)</div>
          <div id="lista" class="muted" style="margin-top:8px">Cargandoâ€¦</div>
        </div>
        <div class="box">
          <div class="pill">ğŸ“£ Eventos</div>
          <div id="eventos" class="muted" style="margin-top:8px">â€”</div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import {
    hostEnsureDefaults, hostListen, hostStartGame, hostBackToLobby, hostResetAll,
    lobbyListen, pushEvent, eventsListen
  } from "./firebase.js";

  const $ = (id)=>document.getElementById(id);

  await hostEnsureDefaults();

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function renderLobby(obj){
    const count = obj ? Object.keys(obj).length : 0;
    $("count").textContent = count;

    if(!obj){ $("lista").innerHTML = "â€”"; return; }
    const arr = Object.values(obj).filter(Boolean).slice(-35).reverse();
    $("lista").innerHTML = `<ul>${arr.map(x=>{
      const tag = x.status === "salio" ? " â€” saliÃ³" : "";
      return `<li>${escapeHtml(x.nombre||"")}${tag}</li>`;
    }).join("")}</ul>`;
  }

  function renderEventos(obj){
    if(!obj){ $("eventos").innerHTML = "â€”"; return; }
    const arr = Object.values(obj).filter(Boolean).slice(-8).reverse();
    $("eventos").innerHTML = `<ul>${arr.map(e=>`<li>${escapeHtml(e.texto||"")}</li>`).join("")}</ul>`;
  }

  // listeners
  lobbyListen(renderLobby);
  eventsListen(renderEventos);
  hostListen((h)=>{
    const fase = (h && h.fase) ? h.fase : "lobby";
    $("fasePill").textContent = "Fase: " + (fase.charAt(0).toUpperCase()+fase.slice(1));
  });

  // login
  $("btnEntrar").addEventListener("click", ()=>{
    const pin = ($("pin").value || "").trim();
    if(pin !== "2026"){ alert("PIN incorrecto"); return; }
    $("loginCard").style.display = "none";
    $("panelCard").style.display = "block";
  });

  // controles
  $("btnStart").addEventListener("click", async ()=>{
    await pushEvent("ğŸš€ La Licda iniciÃ³ el juego. Â¡Todos a jugar!");
    await hostStartGame();
    alert("Listo: se iniciÃ³ el juego.");
  });

  $("btnLobby").addEventListener("click", async ()=>{
    await pushEvent("â†© La Licda reiniciÃ³ a Lobby.");
    await hostBackToLobby();
  });

  $("btnReset").addEventListener("click", async ()=>{
    const ok = confirm("Â¿Seguro? Esto borra lobby + eventos y reinicia todo.");
    if(!ok) return;
    await hostResetAll();
    await pushEvent("ğŸ§¨ Reset total hecho por la Licda.");
    alert("Reset hecho.");
  });
</script>
</body>
</html>
