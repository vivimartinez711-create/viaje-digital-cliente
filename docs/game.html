<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juego - Viaje Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{margin:0;font-family:"Segoe UI",sans-serif;background:linear-gradient(#0b1020,#13224a);color:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-block;padding:7px 12px;border-radius:999px;font-weight:900;background:rgba(255,255,255,.12)}
    .card{margin-top:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    button{width:100%;padding:12px;border-radius:12px;border:none;font-weight:900;cursor:pointer;background:#2f6df6;color:#fff}
    button:hover{background:#2457c6}
    .opt{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14);padding:12px;border-radius:14px;cursor:pointer}
    .opt:hover{background:rgba(255,255,255,.16)}
    .muted{opacity:.85}
    .boss{font-weight:900}
    .danger{color:#ffb3b3}
    a{color:#a8c6ff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="pill" id="nivelPill">Nivel 1</div>
        <div class="pill" id="vidasPill">â¤ï¸â¤ï¸â¤ï¸</div>
        <div class="pill" id="scorePill">Puntos: 0</div>
      </div>
      <div class="muted">
        <a href="./index.html">â† Volver</a>
      </div>
    </div>

    <div class="card">
      <div class="muted">Jugador:</div>
      <div style="font-size:22px;font-weight:900" id="playerName">â€”</div>
      <div class="muted" id="playerMeta" style="margin-top:6px">â€”</div>
    </div>

    <div class="card" id="gameCard">
      <div class="boss" id="bossLine">ğŸ‘©â€ğŸ« Licda: â€œÂ¡Vamos con la primera!â€</div>
      <h2 id="qText" style="margin:12px 0 8px">Cargandoâ€¦</h2>
      <div class="muted" id="qSub">Elige una opciÃ³n</div>

      <div id="opts" class="row" style="margin-top:12px"></div>

      <div style="margin-top:12px" class="muted" id="msg"></div>
    </div>

    <div class="card" id="endCard" style="display:none">
      <h2 id="endTitle">Fin</h2>
      <div id="endText" class="muted"></div>
      <div style="margin-top:12px">
        <button id="btnAgain">Volver a Lobby</button>
      </div>
    </div>
  </div>

<script type="module">
  import { hostListen } from "./firebase.js";

  // âœ… Si el host regresa a lobby, te saca del juego automÃ¡ticamente:
  hostListen((h)=>{
    const fase = (h && h.fase) ? h.fase : "lobby";
    if (fase === "lobby") {
      // opcional: volver al lobby
      // window.location.href = "./index.html";
    }
  });

  const playerId = sessionStorage.getItem("vd_playerId") || "";
  const joined = sessionStorage.getItem("vd_joined") === "1";
  const nombre = (sessionStorage.getItem("vd_nombre") || "").trim();

  // intentamos leer lo que ya estÃ¡ en inputs del lobby (si no, solo nombre)
  const playerName = sessionStorage.getItem("vd_playerName") || "";
  document.getElementById("playerName").textContent = playerName || "Estudiante";

  // --- Juego (3 niveles, 2 preguntas por nivel)
  const levels = [
    {
      boss: "ğŸ‘©â€ğŸ« Licda: â€œNivel 1: lo bÃ¡sico.â€",
      qs: [
        {
          q: "En el viaje digital del cliente, Â¿quÃ© significa â€œmomento de verdadâ€?",
          a: [
            "Un punto de interacciÃ³n que define la percepciÃ³n del cliente",
            "Un descuento sorpresa en la compra",
            "El logo de la empresa"
          ],
          ok: 0
        },
        {
          q: "Â¿CuÃ¡l es el objetivo principal de una experiencia omnicanal?",
          a: [
            "Tener redes sociales bonitas",
            "Que el cliente viva una experiencia consistente en todos los canales",
            "Usar solo un canal para vender"
          ],
          ok: 1
        }
      ]
    },
    {
      boss: "ğŸ§‘â€ğŸ« Profe exigente: â€œNivel 2: estrategia y datos.â€",
      qs: [
        {
          q: "Â¿QuÃ© KPI es mÃ¡s Ãºtil para medir fricciÃ³n en un proceso digital?",
          a: [
            "Tasa de abandono (drop-off) en el flujo",
            "Cantidad de colores en la web",
            "NÃºmero de memes publicados"
          ],
          ok: 0
        },
        {
          q: "Â¿Para quÃ© se usa un mapa del viaje del cliente (customer journey map)?",
          a: [
            "Para ver pasos, emociones y puntos de dolor del cliente",
            "Para decorar presentaciones",
            "Para reemplazar el servicio al cliente"
          ],
          ok: 0
        }
      ]
    },
    {
      boss: "ğŸ‘©â€ğŸ’¼ Jefe final: â€œNivel 3: transformaciÃ³n digital real.â€",
      qs: [
        {
          q: "Â¿QuÃ© combinaciÃ³n es mÃ¡s sana para transformar una experiencia digital?",
          a: [
            "TecnologÃ­a + procesos + personas",
            "Solo comprar software caro",
            "Solo capacitar y ya"
          ],
          ok: 0
        },
        {
          q: "Si el cliente se queja de â€œrespuestas diferentesâ€ por canal, Â¿quÃ© falta?",
          a: [
            "Consistencia y gobernanza omnicanal",
            "MÃ¡s emojis en el chat",
            "Que el cliente se acostumbre"
          ],
          ok: 0
        }
      ]
    }
  ];

  let levelIdx = 0;
  let qIdx = 0;
  let lives = 3;
  let score = 0;

  const $ = (id)=>document.getElementById(id);

  function renderHUD(){
    $("nivelPill").textContent = `Nivel ${levelIdx+1}`;
    $("vidasPill").textContent = "â¤ï¸".repeat(lives) + "ğŸ–¤".repeat(Math.max(0,3-lives));
    $("scorePill").textContent = `Puntos: ${score}`;
  }

  function showQuestion(){
    renderHUD();
    const L = levels[levelIdx];
    const Q = L.qs[qIdx];

    $("bossLine").textContent = L.boss;
    $("qText").textContent = Q.q;
    $("qSub").textContent = "Elige una opciÃ³n";
    $("msg").textContent = "";

    $("opts").innerHTML = Q.a.map((txt,i)=>`
      <div class="opt" data-i="${i}">
        <b>${String.fromCharCode(65+i)}.</b> ${txt}
      </div>
    `).join("");

    [...document.querySelectorAll(".opt")].forEach(el=>{
      el.addEventListener("click", ()=>pick(parseInt(el.dataset.i,10)));
    });
  }

  function pick(i){
    const L = levels[levelIdx];
    const Q = L.qs[qIdx];

    if(i === Q.ok){
      score += 10;
      $("msg").innerHTML = "âœ… Correcto. Â¡Sigue!";
    }else{
      lives -= 1;
      $("msg").innerHTML = `<span class="danger">âŒ Incorrecto.</span> Te queda(n) ${lives} vida(s).`;
    }

    renderHUD();

    setTimeout(()=>{
      if(lives <= 0){
        end(false);
        return;
      }
      qIdx++;
      if(qIdx >= L.qs.length){
        levelIdx++;
        qIdx = 0;
        if(levelIdx >= levels.length){
          end(true);
          return;
        }
      }
      showQuestion();
    }, 900);
  }

  function end(win){
    $("gameCard").style.display = "none";
    $("endCard").style.display = "block";
    $("endTitle").textContent = win ? "ğŸ† Â¡Ganaste!" : "ğŸ’€ Game Over";
    $("endText").innerHTML = win
      ? `La Licda: â€œÂ¡Excelente! Te espero en mi prÃ³ximo curso ğŸ˜ŒğŸ”¥â€<br><br><b>Puntos:</b> ${score}`
      : `La Licda: â€œHoy no se pudoâ€¦ pero maÃ±ana sÃ­ ğŸ˜Œâ€<br><br><b>Puntos:</b> ${score}`;
  }

  $("btnAgain").addEventListener("click", ()=>{
    window.location.href = "./index.html";
  });

  // Si alguien entra directo sin lobby, lo dejamos jugar igual
  $("playerName").textContent = sessionStorage.getItem("vd_playerName") || "Estudiante";
  $("playerMeta").textContent = "Modo juego en vivo";

  showQuestion();
</script>
</body>
</html>

