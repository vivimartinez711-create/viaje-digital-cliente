<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Juego - Viaje Digital</title>
  <style>
    body{margin:0;font-family:Segoe UI,system-ui;background:linear-gradient(#0b1020,#13224a);color:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .pill{display:inline-block;padding:7px 12px;border-radius:999px;font-weight:900;background:rgba(255,255,255,.12);margin-right:8px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:16px;margin-top:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    .opt{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14);padding:12px;border-radius:14px;cursor:pointer}
    .opt:hover{background:rgba(255,255,255,.16)}
    button{width:100%;padding:12px;border-radius:12px;border:none;font-weight:900;cursor:pointer;background:#2f6df6;color:#fff}
    button:hover{background:#2457c6}
    .muted{opacity:.85}
    .danger{color:#ffb3b3}
    .ok{color:#b9ffd2}
  </style>
</head>
<body>
<div class="wrap">
  <div>
    <span class="pill" id="phase">Fase: juego</span>
    <span class="pill" id="hearts">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</span>
    <span class="pill" id="score">Puntos: 0</span>
  </div>

  <div class="card">
    <div class="muted">Jugador:</div>
    <div style="font-size:22px;font-weight:900" id="name">â€”</div>
    <div class="muted" id="meta" style="margin-top:6px">â€”</div>
  </div>

  <div class="card" id="game">
    <div style="font-weight:900" id="nTitle">Nivel 1</div>
    <h2 id="q" style="margin:12px 0 6px">Cargandoâ€¦</h2>
    <div class="muted" id="msg">Elige una opciÃ³n</div>
    <div id="opts" class="row" style="margin-top:12px"></div>
  </div>

  <div class="card" id="rankCard">
    <b>ğŸ† Ranking en vivo</b>
    <div id="rank" class="muted" style="margin-top:8px">â€”</div>
  </div>

  <div class="card" id="end" style="display:none">
    <h2 id="endTitle">Fin</h2>
    <div id="endText" class="muted"></div>
    <div style="margin-top:12px"><button onclick="location.href='./index.html'">Volver al lobby</button></div>
  </div>
</div>

<script type="module">
  import {
    hostListen, leaderboardListen, updatePlayer, submitLeaderboard, pushEvent
  } from "./firebase.js";

  const $=(id)=>document.getElementById(id);
  const esc=(s)=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

  const playerId = sessionStorage.getItem("vd_id") || "";
  const nombre = sessionStorage.getItem("vd_nombre") || "Estudiante";

  $("name").textContent = nombre;
  $("meta").textContent = "Responde rÃ¡pido y suma puntos. (5 corazones)";

  // Si el host manda a lobby, te â€œsacaâ€
  hostListen(h=>{
    const phase = h?.phase || "lobby";
    $("phase").textContent = "Fase: " + phase;
    if(phase === "lobby") location.href = "./index.html";
  });

  leaderboardListen(obj=>{
    if(!obj){ $("rank").textContent="â€”"; return; }
    const arr = Object.values(obj).filter(Boolean)
      .sort((a,b)=> (b.score||0)-(a.score||0))
      .slice(0,10);
    $("rank").innerHTML = "<ol>" + arr.map(r=>`<li><b>${esc(r.nombre)}</b> â€” ${Number(r.score||0)} pts</li>`).join("") + "</ol>";
  });

  // ------- PREGUNTAS (las tuyas) -------
  const quiz = [
    {nivel:"ğŸŸ¢ NIVEL 1 â€“ CONCEPTOS CLAVE", q:"Â¿QuÃ© es la experiencia del cliente?", a:["El precio que paga el cliente","La publicidad de la empresa","La percepciÃ³n total del cliente en todas sus interacciones","Solo el servicio postventa"], ok:2},
    {nivel:"ğŸŸ¢ NIVEL 1 â€“ CONCEPTOS CLAVE", q:"Â¿En quÃ© momento se construye la experiencia del cliente?", a:["Solo cuando compra","Solo cuando hay un problema","Antes, durante y despuÃ©s de la compra","Al final del proceso"], ok:2},
    {nivel:"ğŸŸ¢ NIVEL 1 â€“ CONCEPTOS CLAVE", q:"Â¿CuÃ¡l es el principal rol de los medios digitales en la experiencia del cliente?", a:["Reemplazar a las personas","Aumentar publicidad","Facilitar la interacciÃ³n y el servicio al cliente","Reducir costos Ãºnicamente"], ok:2},
    {nivel:"ğŸŸ¢ NIVEL 1 â€“ CONCEPTOS CLAVE", q:"La tecnologÃ­a en la experiencia del cliente debe verse como:", a:["Un fin en sÃ­ mismo","Un gasto innecesario","Un habilitador de la experiencia","Un reemplazo total de la atenciÃ³n humana"], ok:2},

    {nivel:"ğŸŸ¡ NIVEL 2 â€“ ESTRATEGIA DIGITAL", q:"Â¿CuÃ¡l es el objetivo principal de una estrategia digital centrada en el cliente?", a:["Usar mÃ¡s plataformas","Reducir fricciones y generar valor","Automatizar todo","Tener presencia en redes sociales"], ok:1},
    {nivel:"ğŸŸ¡ NIVEL 2 â€“ ESTRATEGIA DIGITAL", q:"Â¿QuÃ© caracterÃ­stica es clave para una buena estrategia digital?", a:["Que cada canal funcione separado","Que solo exista un canal","IntegraciÃ³n coherente entre canales","Uso exclusivo de tecnologÃ­a"], ok:2},
    {nivel:"ğŸŸ¡ NIVEL 2 â€“ ESTRATEGIA DIGITAL", q:"Â¿QuÃ© acciÃ³n ayuda a mejorar la experiencia digital del cliente?", a:["No escuchar al cliente","Conocer sus necesidades y expectativas","Copiar a la competencia","Cambiar el logo"], ok:1},
    {nivel:"ğŸŸ¡ NIVEL 2 â€“ ESTRATEGIA DIGITAL", q:"Â¿Por quÃ© es importante mantener un enfoque humano en lo digital?", a:["Porque la tecnologÃ­a es limitada","Porque reduce costos","Porque detrÃ¡s de cada interacciÃ³n hay una persona","Porque lo digital no funciona solo"], ok:2},

    {nivel:"ğŸ”´ NIVEL 3 â€“ CASOS PRÃCTICOS", q:"Â¿QuÃ© hace bien Amazon en su experiencia digital?", a:["Procesos complicados","Falta de atenciÃ³n postventa","Plataforma Ã¡gil y personalizada","Uso limitado de tecnologÃ­a"], ok:2},
    {nivel:"ğŸ”´ NIVEL 3 â€“ CASOS PRÃCTICOS", q:"Â¿Por quÃ© Amazon es considerado un caso exitoso de experiencia del cliente?", a:["Por su publicidad","Por ofrecer precios bajos Ãºnicamente","Por facilitar todo el recorrido del cliente","Por eliminar la atenciÃ³n humana"], ok:2},
    {nivel:"ğŸ”´ NIVEL 3 â€“ CASOS PRÃCTICOS", q:"Â¿QuÃ© aspecto destaca en el ejemplo de Cemaco en Guatemala?", a:["Venta solo presencial","Falta de informaciÃ³n digital","Uso de comercio electrÃ³nico para facilitar la compra","Procesos confusos para el cliente"], ok:2},
    {nivel:"ğŸ”´ NIVEL 3 â€“ CASOS PRÃCTICOS", q:"Â¿QuÃ© demuestra el caso de Cemaco respecto a los medios digitales?", a:["Que no son necesarios","Que mejoran la experiencia cuando se usan correctamente","Que solo sirven para grandes empresas","Que reemplazan al servicio fÃ­sico"], ok:1},
    {nivel:"ğŸ”´ NIVEL 3 â€“ CASOS PRÃCTICOS", q:"Â¿QuÃ© problema mostrÃ³ LATAM en su experiencia digital durante la pandemia?", a:["Exceso de tiendas fÃ­sicas","DigitalizaciÃ³n sin estrategia centrada en el cliente","Falta de redes sociales","Poca publicidad"], ok:1},
    {nivel:"ğŸ”´ NIVEL 3 â€“ CASOS PRÃCTICOS", q:"Â¿CuÃ¡l fue un error clave en el caso LATAM desde la experiencia del cliente?", a:["Uso de tecnologÃ­a avanzada","AtenciÃ³n clara y empÃ¡tica","AutomatizaciÃ³n excesiva sin enfoque humano","IntegraciÃ³n correcta de canales"], ok:2},

    {nivel:"ğŸ† JEFE FINAL", q:"Â¿CuÃ¡l es la conclusiÃ³n mÃ¡s correcta sobre los medios digitales y la experiencia del cliente?", a:["La tecnologÃ­a lo resuelve todo","La experiencia depende solo del cliente","La experiencia depende de una estrategia digital bien gestionada y centrada en las personas","Lo digital elimina la necesidad de atenciÃ³n humana"], ok:2},
  ];

  let hearts = 5;
  let score = 0;
  let i = 0;
  let locked = false;

  function render(){
    const q = quiz[i];
    $("nTitle").textContent = q.nivel;
    $("q").textContent = q.q;
    $("hearts").textContent = "â¤ï¸".repeat(hearts) + "ğŸ–¤".repeat(Math.max(0,5-hearts));
    $("score").textContent = "Puntos: " + score;
    $("msg").innerHTML = "Elige una opciÃ³n";

    $("opts").innerHTML = q.a.map((t,idx)=>`
      <div class="opt" data-idx="${idx}">
        <b>${String.fromCharCode(65+idx)}.</b> ${esc(t)}
      </div>
    `).join("");

    document.querySelectorAll(".opt").forEach(el=>{
      el.onclick=()=>pick(Number(el.dataset.idx));
    });
  }

  async function pick(ans){
    if(locked) return;
    locked = true;

    const q = quiz[i];
    const ok = (ans === q.ok);

    if(ok){
      score += 10;
      $("msg").innerHTML = `<span class="ok">âœ… Correcto</span> (+10)`;
    }else{
      hearts -= 1; // â€œmedia vidaâ€ aquÃ­ equivale a 1 corazÃ³n (tienes 5)
      $("msg").innerHTML = `<span class="danger">âŒ Incorrecto</span> (-1 corazÃ³n)`;
    }

    // guarda en RTDB (por si quieres ver avance)
    if(playerId){
      await updatePlayer(playerId, { hearts, score, qIndex: i, finished: false });
    }

    setTimeout(async ()=>{
      if(hearts <= 0){
        await lose();
        return;
      }
      i++;
      if(i >= quiz.length){
        await win();
        return;
      }
      locked = false;
      render();
    }, 800);
  }

  async function lose(){
    $("game").style.display="none";
    $("end").style.display="block";
    $("endTitle").textContent = "ğŸ’€ Te quedaste sin corazones";
    $("endText").innerHTML = `
      <b>Jefe (traje gris):</b> â€œSigue estudiando, suerte para el siguiente curso.â€<br>
      <b>Licda:</b> â€œEn la prÃ³xima lo lograrÃ¡s, no te desanimes.â€ ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶
      <br><br><b>Puntos:</b> ${score}
    `;
    if(playerId) await updatePlayer(playerId, { hearts:0, score, finished:true });
    await pushEvent(`ğŸ˜µ ${nombre} se quedÃ³ sin corazones.`);
    // tambiÃ©n lo subimos al ranking (aunque pierda)
    await submitLeaderboard(playerId || (Date.now()+""), nombre, score);
  }

  async function win(){
    $("game").style.display="none";
    $("end").style.display="block";
    $("endTitle").textContent = "ğŸ† Â¡Ganaste!";
    $("endText").innerHTML = `
      <b>Licda:</b> â€œÂ¡Excelente! Felicidades.â€ ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶<br>
      ğŸ‰ Confeti para 1er lugar ğŸ‰<br><br><b>Puntos:</b> ${score}
    `;
    if(playerId) await updatePlayer(playerId, { hearts, score, finished:true });
    await pushEvent(`ğŸ† ${nombre} terminÃ³ el juego con ${score} puntos.`);
    await submitLeaderboard(playerId || (Date.now()+""), nombre, score);
  }

  render();
</script>
</body>
</html>
