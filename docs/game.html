<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>El Viaje Digital del Cliente ‚Äî Juego en vivo</title>
<style>
  :root{--card:rgba(255,255,255,.12);--border:rgba(255,255,255,.18);--txt:#fff}
  body{margin:0;font-family:system-ui,Segoe UI,Arial;color:var(--txt);min-height:100vh;background:linear-gradient(180deg,#0b56c1,#071a35)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 12px}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid var(--border);font-weight:900}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:0 20px 45px rgba(0,0,0,.35)}
  .q{font-size:20px;font-weight:900;margin:4px 0 8px}
  .muted{opacity:.85}
  .opts{display:grid;gap:8px;margin-top:10px}
  button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.12);color:#fff;font-weight:900;cursor:pointer;text-align:left}
  button:hover{background:rgba(255,255,255,.20)}
  button[disabled]{opacity:.55;cursor:not-allowed}
  .msg{margin-top:10px;font-weight:900}
  .good{color:#39d98a} .bad{color:#ff4d6d}
  .arena{display:flex;flex-wrap:wrap;gap:10px}
  .chip{width:160px;border-radius:16px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);padding:10px}
  .mini{height:46px;border-radius:12px;position:relative;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);overflow:hidden}
  .hair{position:absolute;left:50px;top:7px;width:34px;height:12px;border-radius:12px}
  .head{position:absolute;left:52px;top:11px;width:26px;height:26px;border-radius:999px}
  .shirt{position:absolute;left:44px;top:27px;width:42px;height:16px;border-radius:10px}
  .nm{font-weight:900;margin-top:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{font-size:12px;opacity:.88}
  .hearts{color:#ff2a67;letter-spacing:1px}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.78);padding:18px;z-index:999}
  .box{max-width:780px;background:#111827;border:1px solid rgba(255,255,255,.18);border-radius:18px;padding:18px;text-align:center}
  .big{font-size:20px;font-weight:900}
  .conf{font-size:34px;letter-spacing:2px}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <span class="pill" id="roomPill">C√≥digo: ‚Äî</span>
    <span class="pill" id="levelPill">Nivel: ‚Äî</span>
    <span class="pill" id="statePill">Estado: ‚Äî</span>
    <span class="pill" id="mePill">Yo: ‚Äî</span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="q" id="question">Esperando a la host‚Ä¶</div>
      <div class="muted" id="sub">Cuando la host inicie, aparecer√°n preguntas por nivel.</div>
      <div class="opts" id="opts"></div>
      <div class="msg" id="msg"></div>
      <div class="muted" style="margin-top:10px">
        Regla: si fallas, pierdes la mitad de tus corazones (5‚Üí2‚Üí1‚Üí0). Con 0, quedas fuera.
      </div>
    </div>

    <div class="card">
      <div class="q">üè´ Sal√≥n en vivo</div>
      <div class="muted">Todos conectados (se actualiza en tiempo real).</div>
      <div class="arena" id="arena"></div>
    </div>
  </div>
</div>

<div class="overlay" id="ov">
  <div class="box">
    <div class="conf" id="conf">üéì</div>
    <div class="big" id="ovTitle">Pausa</div>
    <div class="muted" id="ovText">‚Äî</div>
  </div>
</div>

<script type="module">
import { db, dbRef, dbOnValue, dbUpdate, dbGet, qs } from "./firebase.js";

const room = qs("room") || localStorage.getItem("vdc_room") || "CLASE1";
const playerId = localStorage.getItem("vdc_playerId");

document.getElementById("roomPill").textContent = `C√≥digo: ${room}`;

const QUESTIONS = [
  // NIVEL 1 (ma√±ana) ‚Äî 4 preguntas
  { level:1, time:"ma√±ana", q:"¬øQu√© es la experiencia del cliente?", a:["El precio que paga","La publicidad","La percepci√≥n total en todas sus interacciones","Solo el postventa"], correct:2 },
  { level:1, time:"ma√±ana", q:"¬øEn qu√© momento se construye la experiencia del cliente?", a:["Solo cuando compra","Solo cuando hay problema","Antes, durante y despu√©s","Al final"], correct:2 },
  { level:1, time:"ma√±ana", q:"Rol de medios digitales en la experiencia:", a:["Reemplazar personas","Solo publicidad","Facilitar interacci√≥n y servicio","Solo reducir costos"], correct:2 },
  { level:1, time:"ma√±ana", q:"La tecnolog√≠a debe verse como:", a:["Un fin","Un gasto","Un habilitador de la experiencia","Un reemplazo humano total"], correct:2 },

  // NIVEL 2 (tarde) ‚Äî 3 preguntas
  { level:2, time:"tarde", q:"Objetivo de estrategia digital centrada en cliente:", a:["Usar m√°s plataformas","Reducir fricciones y generar valor","Automatizar todo","Solo redes"], correct:1 },
  { level:2, time:"tarde", q:"Clave de una buena estrategia digital:", a:["Canales separados","Solo un canal","Integraci√≥n coherente","Solo tecnolog√≠a"], correct:2 },
  { level:2, time:"tarde", q:"¬øPor qu√© mantener enfoque humano?", a:["Tecnolog√≠a limitada","Baja costos","Detr√°s hay una persona","Lo digital no sirve"], correct:2 },

  // NIVEL 3 (noche) ‚Äî 3 preguntas
  { level:3, time:"noche", q:"¬øQu√© hace bien Amazon en su experiencia digital?", a:["Procesos complicados","Falta de postventa","Plataforma √°gil y personalizada","Uso limitado"], correct:2 },
  { level:3, time:"noche", q:"¬øQu√© demuestra Cemaco respecto a medios digitales?", a:["No son necesarios","Mejoran la experiencia si se usan bien","Solo grandes empresas","Reemplazan lo f√≠sico"], correct:1 },
  { level:3, time:"noche", q:"Conclusi√≥n correcta:", a:["Tecnolog√≠a lo resuelve todo","Depende solo del cliente","Depende de estrategia centrada en personas","Elimina atenci√≥n humana"], correct:2 },
];

function esc(s){return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]))}
function hearts(n){return "‚ô•".repeat(Math.max(0,n)).split("").join(" ");}

function setBg(level,time){
  if(level===1) document.body.style.background = "linear-gradient(180deg,#0b56c1,#071a35)";
  if(level===2) document.body.style.background = "linear-gradient(180deg,#b45309,#111827)";
  if(level===3) document.body.style.background = "linear-gradient(180deg,#4338ca,#0b1220)";
  document.getElementById("levelPill").textContent = `Nivel: ${level} ‚Äî ${time}`;
}

function renderArena(players){
  const arr = Object.values(players||{}).sort((a,b)=> (b.score-a.score) || (b.lives-a.lives) || a.joinedAt-b.joinedAt);
  document.getElementById("arena").innerHTML = arr.map(p=>`
    <div class="chip" style="opacity:${p.out?0.5:1};outline:${p.id===playerId?'2px solid rgba(255,255,255,.55)':'none'}">
      <div class="mini">
        <div class="hair" style="background:${p.hair}"></div>
        <div class="head" style="background:${p.skin}"></div>
        <div class="shirt" style="background:${p.shirt};${p.shirt==="#ffffff"?"border:1px solid rgba(0,0,0,.20)":""}"></div>
      </div>
      <div class="nm">${p.gender==="mujer"?"üë©‚Äçüéì":"üë®‚Äçüéì"} ${esc(p.name)}</div>
      <div class="meta"><span class="hearts">${hearts(p.lives)}</span> ¬∑ ‚≠ê ${p.score}</div>
      <div class="meta">${p.out ? "üö™ Fuera" : (p.answered ? "‚úÖ Respondi√≥" : "‚è≥ Sin responder")}</div>
    </div>
  `).join("");
}

function showOverlay(title, text, conf="üéì"){
  document.getElementById("conf").textContent = conf;
  document.getElementById("ovTitle").textContent = title;
  document.getElementById("ovText").innerHTML = text;
  document.getElementById("ov").style.display = "flex";
}
function hideOverlay(){ document.getElementById("ov").style.display = "none"; }

function renderQuestion(state){
  const statePill = document.getElementById("statePill");
  statePill.textContent = `Estado: ${state.state || "‚Äî"}`;

  if(state.paused){
    showOverlay("üèõÔ∏è Pausa", state.pauseText || "‚Äî", "üéì");
  } else {
    hideOverlay();
  }

  if(state.state !== "playing"){
    document.getElementById("question").textContent = "Esperando a la host‚Ä¶";
    document.getElementById("sub").textContent = "Cuando inicie, aparecer√°n preguntas por nivel.";
    document.getElementById("opts").innerHTML = "";
    document.getElementById("msg").textContent = "";
    return;
  }

  const q = QUESTIONS[state.qIndex] || null;
  if(!q){
    document.getElementById("question").textContent = "Juego terminado (espera resultados).";
    document.getElementById("opts").innerHTML = "";
    return;
  }

  setBg(q.level, q.time);
  document.getElementById("question").textContent = `(${state.qIndex+1}/${QUESTIONS.length}) ${q.q}`;
  document.getElementById("sub").textContent = `Nivel ${q.level} ‚Äî ${q.time}. Elige una opci√≥n.`;

  const letters = ["A","B","C","D"];
  const meAnswered = state.players?.[playerId]?.answered;
  document.getElementById("opts").innerHTML = q.a.map((t,i)=>`
    <button ${meAnswered?"disabled":""} data-i="${i}">${letters[i]}) ${esc(t)}</button>
  `).join("");

  document.querySelectorAll("button[data-i]").forEach(btn=>{
    btn.onclick = ()=> submitAnswer(Number(btn.dataset.i), q.correct);
  });
}

async function submitAnswer(choice, correct){
  if(!playerId) return alert("No est√°s registrado. Vuelve a index.html");
  const pSnap = await dbGet(dbRef(db, `rooms/${room}/players/${playerId}`));
  const p = pSnap.val();
  if(!p || p.out) return;

  if(p.answered) return;

  const isCorrect = (choice === correct);
  let lives = p.lives;
  let score = p.score;

  if(isCorrect){
    score += 10;
  } else {
    lives = Math.floor(lives / 2);
    if(lives < 0) lives = 0;
  }

  const out = lives <= 0;

  await dbUpdate(dbRef(db, `rooms/${room}/players/${playerId}`), {
    answered: true,
    lastAnswer: choice,
    lives,
    score,
    out
  });

  document.getElementById("msg").innerHTML = isCorrect
    ? `<span class="good">‚úÖ Correcto.</span> Espera la siguiente pregunta.`
    : `<span class="bad">‚ùå Incorrecto.</span> Perdiste la mitad de tus corazones.`;
}

async function loadMe(){
  if(!playerId) { document.getElementById("mePill").textContent = "Yo: ‚Äî"; return; }
  const snap = await dbGet(dbRef(db, `rooms/${room}/players/${playerId}`));
  const me = snap.val();
  document.getElementById("mePill").textContent = me ? `Yo: ${me.name}` : "Yo: ‚Äî";
}
loadMe();

// escuchar room (estado + jugadores)
dbOnValue(dbRef(db, `rooms/${room}`), snap=>{
  const state = snap.val() || {};
  renderArena(state.players || {});
  renderQuestion(state);
});
</script>
</body>
</html>
