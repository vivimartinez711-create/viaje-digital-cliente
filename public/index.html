<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Viaje Digital del Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(#b3d9ff, #e6f2ff);
      text-align: center;
    }
    h1 { margin-top: 30px; }
    .card {
      background: white;
      width: 90%;
      max-width: 420px;
      margin: 30px auto;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,.15);
    }
    select, input, button {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    button {
      background: #004aad;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #00317a; }

    .emoji { font-size: 2em; margin-top: 10px; }
    .live {
      text-align: left;
      font-size: 0.95em;
      line-height: 1.6;
      padding: 10px 12px;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      background: #fafcff;
      margin-top: 10px;
      max-height: 160px;
      overflow: auto;
    }
    .hint { font-size: .9em; color:#444; margin-top: 10px; }
  </style>
</head>

<body>

<h1>ğŸ“ El Viaje Digital del Cliente</h1>
<p>Experiencia universitaria interactiva</p>

<div class="card">
  <h3>ğŸ‘¤ Tu nombre</h3>
  <input id="nombre" placeholder="Ej. Ana, Carlos..." />

  <h3>ğŸš Â¿CÃ³mo llegas a la U?</h3>
  <select id="transporte">
    <option value="bus">ğŸšŒ Bus (gallinera)</option>
    <option value="carro">ğŸš— Carro</option>
    <option value="moto">ğŸï¸ Moto</option>
    <option value="pie">ğŸš¶ A pie</option>
  </select>

  <h3>ğŸ¨ Personaliza tu personaje</h3>
  <select id="piel">
    <option value="clara">Piel clara</option>
    <option value="media">Piel media</option>
    <option value="oscura">Piel oscura</option>
  </select>

  <select id="pelo">
    <option value="negro">Pelo negro</option>
    <option value="castaÃ±o">Pelo castaÃ±o</option>
    <option value="rubio">Pelo rubio</option>
  </select>

  <select id="ropa">
    <option value="azul">Camisa/Blusa azul</option>
    <option value="verde">Camisa/Blusa verde</option>
    <option value="rosa">Camisa/Blusa rosa</option>
    <option value="gris">Camisa/Blusa gris</option>
  </select>

  <div class="emoji">ğŸ’ğŸ‘©â€ğŸ“ğŸ‘¨â€ğŸ“</div>

  <hr style="margin:18px 0;">
  <h3>ğŸ« SalÃ³n (en vivo)</h3>
  <div id="lista" class="live">Cargando salÃ³n...</div>

  <button onclick="entrar()">Entrar a la Universidad</button>
  <div class="hint">Cuando la Licda inicie el juego, aquÃ­ te enviarÃ¡ al aula de preguntas automÃ¡ticamente.</div>
</div>

<script type="module">
import { db, ref, set, onValue, serverTimestamp, onDisconnect, update } from "./firebase.js";

let myId = null;
let yaEntre = false;

function hearts(n){ return "â¤ï¸".repeat(Math.max(0, n ?? 0)); }

function renderPlayers(lista) {
  const cont = document.getElementById("lista");
  if (!cont) return;

  const players = lista ? Object.entries(lista).map(([id,p])=>({id,...p})) : [];
  if (players.length === 0) {
    cont.innerHTML = "AÃºn no hay estudiantes en el salÃ³n.";
    return;
  }

  players.sort((a,b)=>(a.nombre||"").localeCompare(b.nombre||""));
  cont.innerHTML = players.map(p => {
    const h = hearts(p.vidas ?? 5);
    const st = p.estado || "activo";
    const extra = st !== "activo" ? ` â€” <b>${st}</b>` : "";
    return `â€¢ <b>${p.nombre || "Sin nombre"}</b> ${h}${extra}`;
  }).join("<br>");
}

window.entrar = async function () {
  const nombre = document.getElementById("nombre").value.trim();
  if (!nombre) { alert("Escribe tu nombre primero ğŸ˜Š"); return; }
  if (yaEntre) { alert("Ya estÃ¡s dentro ğŸ˜Š"); return; }

  const transporte = document.getElementById("transporte").value;
  const piel = document.getElementById("piel").value;
  const pelo = document.getElementById("pelo").value;
  const ropa = document.getElementById("ropa").value;

  myId = "p_" + Date.now() + "_" + Math.floor(Math.random()*9999);

  await set(ref(db, "room/jugadores/" + myId), {
    nombre,
    transporte,
    piel,
    pelo,
    ropa,
    vidas: 5,
    estado: "activo",
    creado: serverTimestamp()
  });

  // Si cierra pestaÃ±a: marcarlo como "salio"
  onDisconnect(ref(db, "room/jugadores/" + myId)).update({ estado: "salio" });

  yaEntre = true;
  alert("ğŸ® Â¡Listo! Ya estÃ¡s en el salÃ³n con el resto del grupo.");
};

// SalÃ³n en vivo
onValue(ref(db, "room/jugadores"), (snap) => renderPlayers(snap.val()));

// Cuando la Licda inicie el juego, manda a game.html
onValue(ref(db, "room/estado"), (snap) => {
  const st = snap.val();
  if (!st) return;

  if (st.fase === "quiz") {
    if (!yaEntre || !myId) {
      alert("La Licda ya iniciÃ³. Primero presiona: 'Entrar a la Universidad'.");
      return;
    }
    window.location.href = "game.html?id=" + encodeURIComponent(myId);
  }
});
</script>

</body>
</html>
